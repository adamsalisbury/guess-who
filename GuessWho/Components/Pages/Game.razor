@page "/game/{Code}"
@rendermode InteractiveServer
@implements IDisposable
@inject GameSessionService GameSessionService
@inject NavigationManager Nav
@using GuessWho.Data
@using GuessWho.Models

<PageTitle>@Code | Guess Who?</PageTitle>

@* ── Session / participant guard ────────────────────────────── *@
@if (_session is null)
{
    <div class="game-placeholder-page">
        <div class="placeholder-card">
            <p>Session not found. <a href="/">Return home</a></p>
        </div>
    </div>
}
else if (_me is null)
{
    <div class="game-placeholder-page">
        <div class="placeholder-card">
            <p>You are not part of this session. <a href="/">Return home</a></p>
        </div>
    </div>
}

@* ── CharacterSelection: picker ─────────────────────────────── *@
else if (_session.Phase == GamePhase.CharacterSelection && !_me.MysteryPersonId.HasValue)
{
    <div class="selection-page">

        <div class="selection-header">
            <h1 class="selection-title">Choose Your Mystery Person</h1>
            <p class="selection-subtitle">
                Your choice is secret —
                <strong>@(_opponent?.Name ?? "your opponent")</strong>
                won't know who you picked.
            </p>
        </div>

        <div class="selection-grid-area">
            <div class="selection-grid">
                @foreach (var character in CharacterData.All)
                {
                    var charId = character.Id;
                    <div class="selection-card-wrap @(_pendingId.HasValue && _pendingId != charId ? "selection-card-wrap--dimmed" : "")">
                        <FaceCard Character="character"
                                  Size="md"
                                  ShowName="true"
                                  IsMystery="@(_pendingId == charId)"
                                  OnClick="@(_ => SetPending(charId))" />
                    </div>
                }
            </div>
        </div>

        <div class="selection-footer">
            @if (_pendingId.HasValue)
            {
                var chosen = CharacterData.GetById(_pendingId.Value)!;
                <div class="selection-chosen">
                    <FaceCard Character="chosen" Size="sm" IsMystery="true" ShowName="false" />
                    <span class="selection-chosen-name">@chosen.Name</span>
                </div>
                <button class="btn btn-primary selection-confirm-btn" @onclick="ConfirmSelection">
                    Confirm — @chosen.Name is my Mystery Person
                </button>
                <button class="btn btn-secondary" @onclick="ClearPending">
                    Change
                </button>
            }
            else
            {
                <p class="selection-hint">Click any character card to select your Mystery Person</p>
            }
        </div>

    </div>
}

@* ── CharacterSelection: waiting for opponent ──────────────── *@
else if (_session.Phase == GamePhase.CharacterSelection && _me.MysteryPersonId.HasValue)
{
    var myPerson = CharacterData.GetById(_me.MysteryPersonId.Value);
    <div class="waiting-page">
        <div class="waiting-card">
            <div class="waiting-mystery">
                <FaceCard Character="myPerson" Size="lg" IsMystery="true" ShowName="true" />
            </div>
            <h2 class="waiting-title">Locked In!</h2>
            <p class="waiting-subtitle">
                Your Mystery Person is
                <strong class="waiting-highlight">@myPerson?.Name</strong>.
            </p>
            <p class="waiting-subtitle">
                Waiting for <strong>@(_opponent?.Name ?? "your opponent")</strong> to choose…
            </p>
            <div class="spinner waiting-spinner"></div>
        </div>
    </div>
}

@* ── Playing phase — full game board ───────────────────────── *@
else if (_session.Phase == GamePhase.Playing)
{
    var myPerson = CharacterData.GetById(_me!.MysteryPersonId ?? 0);

    <div class="game-board">

        @* ════════════════════════════════════════════════════════
           LEFT COLUMN — opponent board (top) + own board (bottom)
           ════════════════════════════════════════════════════════ *@
        <div class="game-left">

            @* ── Opponent's board (top, sm cards, read-only) ─────── *@
            <div class="board-section">
                <div class="board-header">
                    <span class="board-label">@(_opponent?.Name ?? "Opponent")'s Board</span>
                    <span class="board-count">24 characters</span>
                </div>
                <div class="board-grid-area">
                    <div class="board-grid board-grid--sm">
                        @foreach (var charId in _opponent?.BoardOrder ?? [])
                        {
                            var localId = charId;
                            var ch = CharacterData.GetById(localId);
                            <FaceCard Character="ch"
                                      Size="sm"
                                      ShowName="true"
                                      FaceDown="@(_opponent!.EliminatedIds.Contains(localId))" />
                        }
                    </div>
                </div>
            </div>

            <div class="board-divider"></div>

            @* ── Own board (bottom, md cards) ────────────────────── *@
            <div class="board-section board-section--own">
                <div class="board-header">
                    <span class="board-label">@_me!.Name's Board</span>
                    <span class="board-count">Your cards</span>
                </div>
                <div class="board-grid-area">
                    <div class="board-grid board-grid--md">
                        @foreach (var charId in _me!.BoardOrder)
                        {
                            var localId = charId;
                            var ch = CharacterData.GetById(localId);
                            var isMystery = localId == _me!.MysteryPersonId;
                            var isEliminated = _me!.EliminatedIds.Contains(localId);
                            <FaceCard Character="ch"
                                      Size="md"
                                      ShowName="true"
                                      IsMystery="@isMystery"
                                      FaceDown="@isEliminated" />
                        }
                    </div>
                </div>
            </div>

        </div>

        @* ════════════════════════════════════════════════════════
           RIGHT COLUMN — score bar, mystery person, chat panel
           ════════════════════════════════════════════════════════ *@
        <div class="game-right">

            @* ── Score & status bar ──────────────────────────────── *@
            <div class="score-bar">
                <div class="score-round">Round @_session.RoundNumber</div>
                <div class="score-display">
                    <span class="score-name">@_session.Player1?.Name</span>
                    <span class="score-value">@_session.Player1?.RoundWins</span>
                    <span class="score-dash">–</span>
                    <span class="score-value">@_session.Player2?.RoundWins</span>
                    <span class="score-name score-name--right">@_session.Player2?.Name</span>
                </div>
                <div class="turn-status @(_isMyTurn ? "turn-status--active" : "turn-status--waiting")">
                    @if (_isMyTurn)
                    {
                        <span class="turn-indicator-dot"></span>
                        <span>Your turn, @(_me?.Name ?? "you")</span>
                    }
                    else
                    {
                        <span>Waiting for @(_opponent?.Name ?? "opponent")…</span>
                    }
                </div>
            </div>

            @* ── Mystery Person display ──────────────────────────── *@
            <div class="mystery-panel">
                <div class="mystery-label">Your Mystery Person</div>
                @if (myPerson is not null)
                {
                    <div class="mystery-card-wrap">
                        <FaceCard Character="myPerson" Size="lg" IsMystery="true" ShowName="true" />
                    </div>
                }
                <div class="mystery-keep-secret">Keep this secret from your opponent!</div>
            </div>

            @* ── Chat panel ──────────────────────────────────────── *@
            <div class="chat-panel">
                <div class="chat-header">Chat</div>
                <div class="chat-log">
                    <p class="chat-placeholder">The game is afoot…</p>
                </div>
                <div class="chat-input-area">
                    @if (_isMyTurn)
                    {
                        <button class="btn btn-secondary end-turn-btn" @onclick="EndTurn">
                            End Turn
                        </button>
                    }
                    <div class="chat-input-row">
                        <input class="text-input chat-input"
                               type="text"
                               placeholder="@(_isMyTurn ? "Ask a yes/no question…" : "Waiting for your turn…")"
                               disabled="@(!_isMyTurn)" />
                        <button class="btn btn-primary chat-send-btn" disabled="@(!_isMyTurn)">Send</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
}

@* ── Fallback ──────────────────────────────────────────────── *@
else
{
    <div class="game-placeholder-page">
        <div class="placeholder-card">
            <p>Session ended or unavailable. <a href="/">Return home</a></p>
        </div>
    </div>
}

@code {
    [Parameter] public string Code { get; set; } = "";
    [SupplyParameterFromQuery(Name = "name")] public string? PlayerName { get; set; }
    [SupplyParameterFromQuery(Name = "token")] public string? MyToken { get; set; }

    private GameSession? _session;
    private PlayerState? _me;
    private PlayerState? _opponent;

    /// <summary>Card the player has clicked but not yet confirmed.</summary>
    private int? _pendingId;

    /// <summary>True when it is this player's turn to act.</summary>
    private bool _isMyTurn =>
        _session is not null && MyToken is not null && _session.IsActivePlayer(MyToken);

    protected override void OnInitialized()
    {
        _session = GameSessionService.GetSession(Code);
        if (_session is null) return;

        _me       = _session.GetPlayer(MyToken ?? "");
        _opponent = _session.GetOpponent(MyToken ?? "");

        _session.StateChanged += OnSessionStateChanged;
    }

    /// <summary>
    /// Invoked on a thread-pool thread when session state changes.
    /// Marshals the UI update back to this component's Blazor circuit thread.
    /// </summary>
    private async void OnSessionStateChanged(object? sender, EventArgs e)
    {
        await InvokeAsync(() =>
        {
            _opponent = _session?.GetOpponent(MyToken ?? "");
            StateHasChanged();
        });
    }

    /// <summary>Passes the turn to the opposing player.</summary>
    private void EndTurn()
    {
        if (MyToken is not null)
            GameSessionService.StartNextTurn(Code, MyToken);
    }

    private void SetPending(int characterId) => _pendingId = characterId;

    private void ClearPending() => _pendingId = null;

    private void ConfirmSelection()
    {
        if (_pendingId.HasValue && MyToken is not null)
            GameSessionService.SelectMysteryPerson(Code, MyToken, _pendingId.Value);
    }

    public void Dispose()
    {
        if (_session is not null)
            _session.StateChanged -= OnSessionStateChanged;
    }
}
